---
title: "Code Testing"
author: "Ian Roberts"
date: "09/06/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
devtools::load_all()
library(ape)
```

\newcommand{\calJ}{\mathcal{J}}
\newcommand{\calT}{\mathcal{T}}

## Structured Simulation Testing
Generate datasets of size $n$ observations with

  * Random sample times uniform between two years (default 2010 to 2021)
  * Random demes sampled uniformly at random from 1:n.deme (default n.deme = 2)

```{r}
Test.data <- function(n, n.deme = 2, lower.year = 2010, upper.year = 2021){
  data <- matrix(0,nrow = n, ncol = 3)
  data[,1] <- 1:n
  data[,2] <- runif(n, min = lower.year, max = upper.year + 1)
  data[,3] <- sample.int(n.deme, n, replace = TRUE)
  data
}
```

Run $N$ repetitions computing the recursive likelihood under Structured.sim and the likelihood from structured.likelihood with unique test datasets.
```{r}
N <- 100  #Number of repetitions
n <- 100  #Sample size
n.deme <- 2
migration.mat <- matrix(runif(n.deme^2, 0, 0.1),n.deme, n.deme)

likelihoods <- matrix(0,nrow = N,ncol = 2)

for (i in 1:N){
  phylo <- Structured.sim(Test.data(n,n.deme), 1,1,n.deme,migration.mat,FALSE)
  likelihoods[i,1] <- phylo$log.likelihood
  likelihoods[i,2] <- structured.likelihood(phylo,1,1,migration.mat)[1]
}

max(abs(likelihoods[,1] - likelihoods[,2]))
```
Consistently returns discrepancies between calculated likelihoods of order $10^{-13}$ suggesting accurate computations are being made.

*Initially a discrepancy arose from removing the diagonal of migration.mat in Structured.sim but not in structured.likelihood*

Repeating the testing with a greater number of demes:
```{r}
N <- 100
n.deme <- 5

migration.mat <- matrix(runif(n.deme^2),n.deme, n.deme)

likelihoods <- matrix(0,nrow = N,ncol = 2)

for (i in 1:N){
  phylo <- Structured.sim(Test.data(n,n.deme), 1,1,n.deme,migration.mat,FALSE)
  likelihoods[i,1] <- phylo$log.likelihood
  likelihoods[i,2] <- structured.likelihood(phylo,1,1,migration.mat)[1]
}

max(abs(likelihoods[,1] - likelihoods[,2]))
```

confirm that the likelihoods computed under structured.sim agree with the heterochronous coalescent without migration when there is a single deme.
```{r}
n.deme <- 1
N <- 100

migration.mat <- matrix(1,1,1)

likelihoods <- matrix(0,N,3)

for (i in 1:N){
  phylo <- Structured.sim(Test.data(n,n.deme), 1,1,n.deme,migration.mat,FALSE)
  likelihoods[i,1] <- phylo$log.likelihood
  likelihoods[i,2] <- structured.likelihood(phylo,1,1,migration.mat)[1]
  likelihoods[i,3] <- phylo.likelihood(phylo,1,1)[1]
}

max(abs(likelihoods[,1] - likelihoods[,2]))
max(abs(likelihoods[,2] - likelihoods[,3]))
```

Consistently, the likelihoods calculated for the structured coalescent with a single deme (using structured.likelihood) correspond exactly to the heterochronous coalescent (using phylo.likelihood)


## MCMC Implementation Testing

Begin by generating a reversible jump MCMC algorithm with only one type of (reversible) move. Initially, select the migration pair birth/death move. This type of move has acceptance probabilities
  \[
    \alpha(\calT' | \calT) = \min \left( 1, \frac{L(\calT') \pi(\calT') Q(\calT | \calT')}{L(\calT) \pi(\calT) Q(\calT' | \calT)} || \calJ || \right),
  \]
where $\calT$ denotes a structured coalescent tree with a full migration history, $L(\calT)$ denotes the likelihood and $\pi(\calT)$ the prior. The Jacobian term is equal to 1 as parameters are being added or deleted but not transformed under the migration pair birth/death move.

For a migration pair birth, it holds that
  \begin{align*}
    Q(\calT' | \calT) & = \bbP [\text{Selected edge}] \cdot \bbP[ \text{New node times}] \cdot \bbP[\text{Selected deme}] \\
      & = \frac{1}{n + M + (n - 2)} \cdot \frac{2}{(t_i - t_{ip})^2} \cdot \frac{1}{d-1},
  \end{align*}
where $i$ and $ip$ denote the ends of the selected edge, and the factor of 2 in the "New node times" term arises from the ordering of the uniformly distributed times. Similarly,
  \begin{align*}
    Q(\calT | \calT') & = \bbP[\text{Selected edge}] \\
      & = \frac{1}{n + (M+2) + (n-2)} = \frac{1}{M+2n}.
  \end{align*}
Thus, the acceptance probability for a migration pair birth is given by
  \[
    \alpha_{PB}(\calT' | \calT) = \min \left( 1, \frac{L(\calT') \pi(\calT')}{L(\calT) \pi(\calT) } \cdot \frac{(M+2n-2)(t_i - t_{ip})^2 (d-1)}{2(M+2n)} \right)
  \]
