---
title: "The Structured Coalescent"
author: "Ian Roberts"
date: "07/06/2021"
output:
  beamer_presentation:
    theme: "Frankfurt"
header-includes:
   - \usepackage{bbm}
   - \usepackage{amsmath, amssymb, amsthm}
   - \newcommand{\bbP}{\mathbb{P}}
bibliography: Bibliography.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
devtools::load_all()
library(ape)
```

## Homochronous Leaves

\alert{Homochronous.Sim} simulates the ordinary Kingman $n$-coalescent, and outputs a phylo object which can potentially be plotted using ape::plot.phylo

```{r, fig.height=4, fig.cap="Homochronous $n$-coalescent simulation using Homochronous.Sim where Effective population $\\times$ generation length = 25"}
HomoPhylo <- Homochronous.Sim(1:5,1,25)
plot(HomoPhylo, show.tip.label = FALSE)
axisPhylo(1, root.time = 2021 - max(node.depth.edgelength(HomoPhylo)), backward = FALSE)
```

## Heterochronous Leaves

- \alert{Heterochronous.sim} again simulates the Kingman $n$-coalescent, outputting a phylo object. Key difference is the option for heterochronous leaves (in continuous years) and optional argument for plotting the phylo object automatically
- Effectively reduces to \alert{Homochronous.sim} if all leaves have the same age
- Example dataset: first column giving sample id and second column giving year of observation

\centering
\begin{tabular}{ccc}
    ID & Year \\ \hline
    1 & 2021 \\
    2 & 2020 \\
    3 & 2021 \\
    4 & 2018 \\
    5 & 2019
  \end{tabular}
```{r}
data <- matrix(c(1:5,2021,2020,2021,2018,2019), ncol = 2)
```

---

```{r, fig.cap="Heterochronous $n$-coalescent simulation using Homochronous.Sim where Effective population $\\times$ generation length = 25", fig.height = 5}

HeteroPhylo <- Heterochronous.Sim(data,1,25, TRUE)

```

## Verification
- Verified the accuracy of \alert{Heterochronous.sim} via likelihood computation. Likelihood calculated recursively as the simulation is run, then compare obtained value with explicit calculation from the final phylo object (using \alert{phylo.likelihood}).
- Likelihood of a heterochronous coalescent process [@Drummond2002] is given by
  \[
    L = \frac{1}{\theta^{n-1}} \, \prod_{i=2}^{2n-1} \exp \left\{ - \frac{k_i (k_i - 1)}{2 \theta_i} (t_i - t_{i-1}) \right\}
  \]
  where 
    - $t_i$ denotes the time of the $i^\text{th}$ event (either a coalescence or adding a newly sampled lineage)
    - $k_i$ denotes the number of current lineages at $t_i$
    - $\theta$ denotes the product of effective population and generation length.

## Structured Coalescent
- \alert{Structured.sim} generates a realisation of the structured coalescent process where at each event time, either:
    - Two lineages in the same deme coalesce
    - One lineage migrates between two demes
- Allows for heterochronous leaves so effectively reduces to \alert{Heterochronous.sim} when there is only one deme
- Example dataset: Augments the previous dataset with a third column giving initial deme of the lineages. Assume 2 demes and an example migration matrix $\Lambda$

\begin{minipage}{0.4\linewidth}
  \flushright
  \begin{tabular}{ccc}
    ID & Year & Deme \\ \hline
    1 & 2021 & 1 \\
    2 & 2020 & 1 \\
    3 & 2021 & 2 \\
    4 & 2018 & 2 \\
    5 & 2019 & 2
  \end{tabular}
\end{minipage} \hfill
\begin{minipage}{0.4\linewidth}
  \[\Lambda = \begin{bmatrix}
    0 & 0.02 \\
    0.05 & 0
  \end{bmatrix} \]
\end{minipage}

---
```{r, fig.cap="Structured heterochronous $n$-coalescent realisation using Structured.sim with Effective population $\\times$ generation length = 25 and migration rates 0.02 ($1 \\rightarrow 2$) and 0.05 ($2 \\rightarrow 1$)", fig.height = 5}
struc.data <- cbind(data,c(1,1,2,2,2))
migration.mat <- matrix(c(0,0.02,0.05,0),ncol=2)
struc.phylo <- Structured.sim(struc.data, 1,25,2,migration.mat,FALSE)

color.palette <- c("red","blue") #rainbow(2)
edge.color <- rep(NA,dim(struc.phylo$edge)[1])
    for (i in 1 : dim(struc.phylo$edge)[1]){
      edge.color[i] <- color.palette[struc.phylo$node.deme[struc.phylo$edge[i,2]]]
    }
    plot(struc.phylo, edge.color = edge.color)
    axisPhylo(1, root.time = 2021 - max(node.depth.edgelength(struc.phylo)), backward = FALSE)
```

## Verification (IN PROGRESS)
- Again, verify by constructing likelihood recursively and compare to the exact form [@Ewing2004]

\[
  L =\ \prod_{i=1}^d \prod_{\substack{j=1 \\ j \neq i}}^d \prod_{r=2}^{2n + M -1} \frac{1}{\theta_i^{c_i}} \lambda_{ij}^{m_{ij}} \exp \left\{ - \left( \frac{k_{i r} (k_{i r} - 1)}{2 \theta_i} + k_{i r} \lambda_{i j} \right)(t_r - t_{r-1}) \right\}
\]

- where
    - $n$ denotes the number of leaves
    - $d$ denotes the number of demes
    - $m$ gives a $d\times d$ matrix with entries $m_{ij}$ giving the number of migrations $(i \rightarrow j)$ and $M = \sum_{i,j = 1}^d m_{ij}$ gives the total number of migration events
    - $c$ gives a $d$-dimensional vector with entries $c_i$ giving the number of coalescence events occuring in deme $i$
    - $k_{ir}$ denotes the number of lineages in deme $i$ at time $t_r$
    
## Recursive log-likelihood
Recursive log-likelihood is calculated by adding a contribution from each of the three possible ways nodes are added to the phylo:
  
- New leaf is added
- Coalescence occurs in deme $i$
- Migration occurs $i \rightarrow j$

## Likelihood contributions
Total coalescence rate $\mathcal{C} = \sum_{i=1}^d \frac{1}{\theta_i}\binom{k_i}{2}$, Total migration rate $\mathcal{M} = \sum_{i=1}^d \sum_{j \neq i} k_i \lambda_{ij}$ and Total event rate: $\mathcal{E} = \mathcal{C} + \mathcal{M}$.

- New leaf added:
    - $L \leftarrow L + \log \left( 1 - \mathcal{E} \exp \{ - \mathcal{E}\boldsymbol{\delta} \} \right)$ where $\boldsymbol{\delta}$ is the time to next new leaf being added
- Coalescence event in deme $i$:
  \begin{align*}
   \scriptstyle L & \scriptstyle \leftarrow L + \log \left( \bbP[\text{Coal}] \bbP[\text{Coal deme}] \bbP[\text{Coal pair}] f_T(t) \right) \\
      & \scriptstyle \phantom{\leftarrow} = L + \log \left( \frac{\mathcal{C}}{\mathcal{E}} \cdot \frac{\frac{1}{\theta_i} \binom{k_i}{2}}{\sum_{j=1}^d \frac{1}{\theta_j} \binom{k_j}{2}} \cdot \binom{k_i}{2}^{-1} \cdot \mathcal{E} \exp \{ -\mathcal{E} t \} \right) = L - \mathcal{E} t - \log \theta_i
  \end{align*}
- Migration event $i \rightarrow j$:
  \begin{align*} 
    \scriptstyle L & \scriptstyle \leftarrow L + \log \left( \bbP[\text{Mig}] \bbP[\text{Mig origin}] \bbP[\text{Mig target}] \bbP[\text{Mig lineage}] f_T(t) \right) \\
      & \scriptstyle \phantom{\leftarrow} = L + \log \left( \frac{\mathcal{M}}{\mathcal{E}} \cdot \frac{k_i \sum_{\eta \neq i} \lambda_{i\eta}}{\sum_{\alpha = 1}^d k_\alpha \sum_{\beta \neq \alpha} \lambda_{\alpha \beta}}
      \cdot \frac{\lambda_{ij}}{\sum_{\gamma \neq i} \lambda_{i \gamma}} \cdot \frac{1}{k_i} \cdot \mathcal{E} \exp \{ -\mathcal{E} t \} \right) = L - \mathcal{E}t + \log(\lambda_{ij})
  \end{align*}

## Testing
```{r, echo = FALSE}
N <- 100; likelihoods <- matrix(0,nrow = N,ncol = 2)

for (i in 1:N){
  phylo <- Structured.sim(struc.data, 1,1,2,migration.mat,FALSE)
  likelihoods[i,1] <- phylo$log.likelihood
  likelihoods[i,2] <- structured.likelihood(phylo,1,1,migration.mat)
}

Max <- max(abs(likelihoods[,2] - likelihoods[,1]))
```
Running `r N` generated processes for the example dataset and comparing the exact likelihood [@Ewing2004] to the recursive likelihood. Maximum discrepancy over the 100 iterations was `r Max`.

```{r, echo = TRUE, eval=FALSE}
N <- 100; likelihoods <- matrix(0,nrow = N,ncol = 2)

for (i in 1:N){
  phylo <- Structured.sim(struc.data, 1,1,2,migration.mat,FALSE)
  likelihoods[i,1] <- phylo$log.likelihood
  likelihoods[i,2] <- structured.likelihood(phylo,1,1,migration.mat)
}

max(abs(likelihoods[,2] - likelihoods[,1]))
```
```{r}
Max
```
## References
